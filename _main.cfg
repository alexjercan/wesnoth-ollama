[modification]
	id=wesnoth_ollama
	name=_"Wesnoth Ollama"
	description=_"Adds a simple ollama integration into Wesnoth"
	type=hybrid
	require_modification=no

    [event]
        name = start

        [set_menu_item]
            id = ollama_query
            description = _"Ask this unit about themselves"

            [show_if]
                [true]
                [/true]
            [/show_if]

            [filter_location]
                [filter]
                    side=$side_number
                [/filter]
            [/filter_location]

            [command]
                [store_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    variable=clicked_unit
                    kill=no
                [/store_unit]

                [message]
                    speaker=narrator
                    message= _"What do you want to ask $clicked_unit.name|?"
                    [text_input]
                        variable=user_text
                        text=""
                        max_length=256
                    [/text_input]
                [/message]

                # Create the initial prompt for the unit with the name and type
                [set_variable]
                    name=unit_system_prompt
                    value="You are $clicked_unit.name|, a $clicked_unit.type| (level $clicked_unit.level|) in the Battle for Wesnoth."
                [/set_variable]
                # Add the unit race and alignment
                [set_variable]
                    name=unit_system_prompt
                    value="$unit_system_prompt| You are of the $clicked_unit.race| race and are $clicked_unit.alignment| aligned."
                [/set_variable]
                # Add the leader status
                [if]
                    [variable]
                        name=clicked_unit.canrecruit
                        equals=yes
                    [/variable]
                    [then]
                        [set_variable]
                            name=unit_system_prompt
                            value="$unit_system_prompt| You are a leader responsible for commanding troops and making strategic decisions."
                        [/set_variable]
                    [/then]
                [/if]
                # Add HP information for the unit
                [if]
                    [variable]
                        name=clicked_unit.hitpoints
                        equals=$clicked_unit.max_hitpoints
                    [/variable]
                    [then]
                        # fully healthy -> no text
                    [/then]
                    [else]
                        [if]
                            [variable]
                                name=clicked_unit.hitpoints
                                less_than=10
                            [/variable]
                            [then]
                                [set_variable]
                                    name=unit_system_prompt
                                    value="$unit_system_prompt| You are badly wounded and struggling to remain standing."
                                [/set_variable]
                            [/then]
                            [else]
                                [set_variable]
                                    name=unit_system_prompt
                                    value="$unit_system_prompt| You are wounded, bearing visible injuries from battle."
                                [/set_variable]
                            [/else]
                        [/if]
                    [/else]
                [/if]
                # Final instruction to keep LLM behavior sane
                [set_variable]
                    name=unit_system_prompt
                    value="$unit_system_prompt| You speak in character, aware of your race, role, and battlefield experience. Answer as the unit would. Stay in character. Do not mention being an AI, a language model, or the real world. Keep responses under 3 short paragraphs unless asked otherwise."
                [/set_variable]

                # [message]
                #     speaker=narrator
                #     message= _"$unit_system_prompt|"
                # [/message]

                [ollama]
                    name=llm_response
                    system_prompt="$unit_system_prompt"
                    model="llama2"
                    prompt="$user_text|"
                [/ollama]

                [message]
                    speaker=$clicked_unit.id
                    message= _"$llm_response|"
                [/message]

                [clear_variable]
                    name=clicked_unit
                [/clear_variable]
            [/command]
        [/set_menu_item]
    [/event]
[/modification]
